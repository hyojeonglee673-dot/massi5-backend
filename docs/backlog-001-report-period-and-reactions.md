# [Backlog-001] 리포트 집계 기준(주/월/연) + 커뮤니티 이모지 규격

## 1. 개요

- **리포트 집계**: 주/월/연 단위로 기간이 일관되게 계산되도록 정의한다.
- **커뮤니티 반응(이모지)**: 허용 종류와 저장 규칙을 정의한다.

---

## 2. 날짜 필터링/집계 기준

### 2.1 타임존

| 항목 | 규칙 |
|------|------|
| **기본 타임존** | 사용자 타임존. 미설정 시 **KST (Asia/Seoul)** 적용. |
| **적용 범위** | 기간 경계(주/월/연의 시작·종료)는 해당 타임존 기준으로 해석한다. |

### 2.2 주(Week)

| 항목 | 규칙 |
|------|------|
| **기준** | **ISO-8601**: 주의 시작은 **월요일**, 종료는 **일요일**. |
| **범위** | 기준일이 속한 주의 월요일 00:00:00 ~ 일요일 23:59:59 (타임존 적용). |

### 2.3 월(Month)

| 항목 | 규칙 |
|------|------|
| **범위** | 해당 월 **1일 00:00:00** ~ **말일 23:59:59** (타임존 적용). |

### 2.4 연(Year)

| 항목 | 규칙 |
|------|------|
| **범위** | **1월 1일 00:00:00** ~ **12월 31일 23:59:59** (타임존 적용). |

### 2.5 API 규격

- **period 타입**: `week` | `month` | `year`
- **기준일(date)**: 이 날짜가 **속한** 주/월/연 전체를 집계한다.
- **해석 방식**: "해당 period 전체" — 기준일이 포함된 캘린더 주/월/연 구간을 사용한다.  
  ("최근 7일/30일/365일" 롤링 윈도우는 별도 파라미터로 지원할 경우 구분한다.)

### 2.6 결정 사항 (체크)

| 결정 항목 | 선택 | 비고 |
|-----------|------|------|
| **주의 시작 요일** | ✅ **월요일(ISO-8601)** | 국제 표준 및 일관성. |
| **리포트 기간 해석** | ✅ **해당 period 전체** | 기준일이 속한 주/월/연. |

---

## 3. 커뮤니티 이모지(반응) 규격

### 3.1 허용 이모지 목록

저장은 **코드값**으로 하며, 클라이언트는 코드값을 아래 이모지로 매핑해 표시한다.

| 코드값 (code) | 표시 이모지 | 설명 |
|---------------|-------------|------|
| `like` | 👍 | 좋아요 |
| `love` | ❤️ | 사랑해요 |
| `yummy` | 😋 | 맛있어 보여요 |

- **저장 방식**: DB 및 API에서는 **코드값(`like`, `love`, `yummy`)만** 사용.
- **표시**: 클라이언트에서 코드값 → 이모지 매핑 테이블로 렌더링.

### 3.2 동일 사용자·동일 기록에 대한 반응 정책

| 항목 | 규칙 |
|------|------|
| **중복** | **중복 불가**. 동일 사용자가 동일 기록에 동일 reaction 타입을 여러 번 남기지 않는다. |
| **구현** | **업서트(Upsert)**: 같은 (lunch_record_id, user_id, reaction_type)이면 기존 행 갱신 또는 1건만 유지. |
| **토글** | 서비스 정책에 따라 "같은 이모지 다시 누르면 취소" 토글 방식 허용 가능. (저장은 여전히 1건 또는 삭제.) |

### 3.3 반응 시 사용자 식별

| 항목 | 규칙 |
|------|------|
| **식별** | **로그인 필요**. 반응을 남기려면 인증된 사용자만 가능. |
| **익명 커뮤니티** | 비로그인 반응은 **허용하지 않음** (추천하지 않음). |

### 3.4 결정 사항 (체크)

| 결정 항목 | 선택 | 비고 |
|-----------|------|------|
| **reaction 중복** | ✅ **중복 불가(업서트)** | 1인 1기록당 타입별 1회. |
| **반응 시 사용자 식별** | ✅ **로그인 필요** | 비로그인 반응 비허용. |

---

## 4. 완료 조건 (Acceptance Criteria)

- [x] 주/월/연 기간 계산 규칙이 문서로 명시되어 있다. (§2)
- [x] 타임존 기준이 명시되어 있다. (§2.1)
- [x] 허용 이모지 목록 및 저장 방식(코드값)이 문서에 있다. (§3.1)
- [x] "동일 사용자의 동일 기록에 대한 중복 반응 정책"이 명시되어 있다. (§3.2)

---

## 5. 코드 참조

- **기간 상수**: `core.report_period` — `PeriodType`, `PERIOD_TYPES`, `WEEK_START`, `DEFAULT_TIMEZONE`
- **반응 상수**: `core.reactions` — `ALLOWED_REACTION_CODES`, `REACTION_CODE_TO_EMOJI`, `is_allowed_reaction_code()`

---

## 6. Out of Scope

- 추천 알고리즘, 랭킹, 배지 등
